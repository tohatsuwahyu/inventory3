<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>在庫管理 - ダッシュボード</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap.min.css'"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap-icons.css'"/>

  <!-- App styles -->
  <link href="styles.css?v=20251107" rel="stylesheet"/>
  <link href="print.css?v=20251030" rel="stylesheet"/>

  <style>
    :root{ --appbar-h:56px; --bg:#f6f8fc; --ink:#0f172a; }
    body{ background:var(--bg); color:var(--ink); }
    header.appbar{
      position:sticky; top:0; z-index:1020; background:#fff;
      border-bottom:1px solid #e5e7eb; height:var(--appbar-h);
      display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem;
    }
    .brand{ display:flex; align-items:center; gap:.5rem; }
    .brand img{ height:28px; }
    .brand .ttl{ font-weight:600; }
    .appbar-actions{ margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    .app-layout{ display:grid; grid-template-columns:240px 1fr; min-height:calc(100dvh - var(--appbar-h)); }
    aside{ background:#fff; border-right:1px solid #e5e7eb; }
    aside .menu{ padding:.75rem; }
    aside .menu a{ display:flex; gap:.5rem; align-items:center; padding:.55rem .75rem; border-radius:.6rem; color:var(--ink); text-decoration:none; }
    aside .menu a.active, aside .menu a:hover{ background:#eef2ff; }
    main{ padding:1rem; }

    /* Welcome badge */
    #welcome-badge{
      display:inline-flex; align-items:center; gap:.5rem;
      background:#e0e7ff; color:#1d4ed8; border-radius:999px;
      padding:.35rem .6rem; font-weight:600; font-size:.95rem;
      box-shadow:0 6px 20px rgba(29,78,216,.12);
    }

    /* Metric cards – vibrant */
    .metrics{ row-gap:1rem; }
    .metric-card{
      position:relative; display:flex; align-items:center; gap:14px; padding:16px;
      border-radius:18px; color:#0b1220; background:#fff; box-shadow:0 10px 30px rgba(2,6,23,.06);
      overflow:hidden; min-height:84px;
    }
    .metric-card .mc-icon{
      width:52px; height:52px; display:grid; place-items:center;
      border-radius:14px; background:#eef2ff;
    }
    .metric-card .mc-label{ font-size:.9rem; color:#6b7280; margin-bottom:2px; }
    .metric-card .mc-value{ font-size:1.75rem; line-height:1.2; font-weight:800; letter-spacing:.5px; }

    .mc-items{ background:linear-gradient(135deg,#eef2ff 0%, #e9f0ff 100%); }
    .mc-items .mc-icon{ background:#dbeafe; color:#1d4ed8; }
    .mc-low{ background:linear-gradient(135deg,#fff1f2 0%, #ffe4e6 100%); }
    .mc-low .mc-icon{ background:#fee2e2; color:#dc2626; }
    .mc-users{ background:linear-gradient(135deg,#ecfdf5 0%, #e6fffa 100%); }
    .mc-users .mc-icon{ background:#dcfce7; color:#16a34a; }

    /* Chart boxes: fixed height, responsive */
    .chart-box{ height:320px; }
    .chart-sm{ height:260px; }
    .chart-lg{ height:340px; }

    /* Sidebar overlay (mobile) */
    #sb-backdrop{ display:none; }
    .sb-open #sb-backdrop{ display:block; position:fixed; inset:0; background:rgba(15,23,42,.25); z-index:1010; }

    /* Hover card (inline item detail) */
    #hover-item{
      position:absolute; z-index:2000; width:min(420px, 92vw);
      background:#fff; border:1px solid #e5e7eb; border-radius:14px;
      box-shadow:0 18px 50px rgba(2,6,23,.18);
      display:none;
    }
    #hover-item .card-body{ padding:12px 14px; }
    #hover-item .thumb{
      width:120px; height:90px; background:#f3f6ff; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden;
    }

    /* Bottom sheet (mobile) */
    @media (max-width: 991.98px){
      .app-layout{ grid-template-columns:0 1fr; }
      aside{ position:fixed; z-index:1025; top:var(--appbar-h); bottom:0; width:260px; transform:translateX(-100%); transition:.2s; }
      .sb-open aside{ transform:none; }
      .metrics .metric-card{ padding:14px; }
      .chart-box{ height:260px; }
      #hover-item.mobile{
        position:fixed; left:0; right:0; bottom:0; width:100%; border-radius:18px 18px 0 0;
        animation:sheetIn .18s ease-out both;
      }
      @keyframes sheetIn{ from{ transform:translateY(12px); opacity:0 } to{ transform:none; opacity:1 } }
    }

    /* Scan areas */
    #io-scan-area, #scan-area, #qio-scan-area, #cy-scan-area{
      background:#0f172a08; border:1px dashed #cbd5e1; border-radius:.6rem;
      display:flex; align-items:center; justify-content:center; min-height:220px;
    }

    /* Table scroll */
    .table-wrap{ overflow:auto; }

    /* Global loading */
    #global-loading{ position:fixed; inset:0; background:rgba(255,255,255,.6); backdrop-filter:saturate(140%) blur(2px);
      z-index:2000; display:flex; align-items:center; justify-content:center; }
  </style>
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button id="btn-menu" class="btn btn-outline-secondary btn-sm d-lg-none"><i class="bi bi-list"></i></button>
    <div class="brand">
      <img id="brand-logo" src="logo.png" alt="logo"/>
      <div class="ttl">在庫管理</div>
    </div>

    <!-- Global Search -->
    <div id="global-search-wrap" class="d-none d-md-block flex-grow-1" style="max-width:520px">
      <input id="global-search" class="form-control form-control-sm" type="search" placeholder="検索（コード／品名／置場）"/>
      <div id="global-search-results" class="list-group small" style="position:absolute;left:0;right:0;top:calc(100% + 4px);z-index:1050;display:none;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;overflow:hidden;box-shadow:0 6px 24px rgba(15,23,42,.08);"></div>
    </div>

    <div class="appbar-actions">
      <span id="who" class="text-muted small"></span>
      <button id="btn-logout" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>
  </header>

  <!-- Layout -->
  <div class="app-layout">
    <!-- Sidebar -->
    <aside>
      <div class="menu">
        <nav class="d-grid gap-1">
          <a href="#" class="active" data-view="view-dashboard"><i class="bi bi-speedometer2"></i><span>ダッシュボード</span></a>
          <a href="#" data-view="view-items"><i class="bi bi-box-seam"></i><span>商品一覧</span></a>
          <a href="#" data-view="view-io"><i class="bi bi-arrow-left-right"></i><span>入出庫</span></a>
          <a href="#" data-view="view-shelf"><i class="bi bi-upc-scan"></i><span>棚卸（簡易）</span></a>
          <a href="#" data-view="view-cycle"><i class="bi bi-clipboard-check"></i><span>棚卸セッション</span></a>
          <a href="#" data-view="view-shelf-list"><i class="bi bi-table"></i><span>棚卸一覧</span></a>
          <a href="#" data-view="view-history"><i class="bi bi-clock-history"></i><span>履歴</span></a>
          <a href="#" data-view="view-users"><i class="bi bi-people"></i><span>ユーザー</span></a>
        </nav>
      </div>
    </aside>
    <div id="sb-backdrop"></div>

    <!-- Main -->
    <main>
      <!-- Dashboard -->
      <section id="view-dashboard" class="active">
        <h5 id="page-title" class="mb-2">ダッシュボード</h5>
        <div class="mb-3"><span id="welcome-badge"><i class="bi bi-hand-thumbs-up"></i> ようこそ</span></div>

        <!-- METRICS -->
        <div class="row metrics">
          <div class="col-12 col-md-4">
            <div class="metric-card mc-items">
              <div class="mc-icon"><i class="bi bi-box-seam fs-4"></i></div>
              <div class="mc-meta">
                <div class="mc-label">商品数</div>
                <div class="mc-value" id="metric-total-items">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="metric-card mc-low">
              <div class="mc-icon"><i class="bi bi-exclamation-triangle fs-4"></i></div>
              <div class="mc-meta">
                <div class="mc-label">在庫不足</div>
                <div class="mc-value" id="metric-low-stock">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="metric-card mc-users">
              <div class="mc-icon"><i class="bi bi-people fs-4"></i></div>
              <div class="mc-meta">
                <div class="mc-label">ユーザー</div>
                <div class="mc-value" id="metric-users">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-lg-8">
            <div class="card"><div class="card-body">
              <div class="fw-semibold mb-2">月次推移</div>
              <div class="chart-box chart-lg"><canvas id="chart-monthly"></canvas></div>
            </div></div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card"><div class="card-body">
              <div class="fw-semibold mb-2">直近 IN/OUT</div>
              <div class="chart-box chart-sm"><canvas id="chart-pie"></canvas></div>
            </div></div>
          </div>
        </div>

        <div class="mt-3">
          <button id="btn-export-mov" class="btn btn-outline-primary"><i class="bi bi-download"></i> 月次IN/OUT CSV</button>
          <button id="fab-quick-io" class="btn btn-primary d-lg-none" style="position:fixed;right:16px;bottom:16px;border-radius:50%;width:56px;height:56px;box-shadow:0 10px 30px rgba(2,6,23,.18)"><i class="bi bi-plus-lg"></i></button>
        </div>
      </section>

      <!-- Items -->
      <section id="view-items" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">商品一覧</h5>
          <div class="d-flex gap-2">
            <input id="items-search" class="form-control form-control-sm" placeholder="フィルタ…"/>
            <button id="btn-items-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> CSV</button>
            <button id="btn-items-xlsx" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-spreadsheet"></i> XLSX</button>
            <button id="btn-items-import" class="btn btn-outline-secondary btn-sm"><i class="bi bi-upload"></i> インポート</button>
            <input id="input-items-import" type="file" accept=".csv" class="d-none"/>
            <button id="btn-open-new-item" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> 新規商品</button>
          </div>
        </div>

        <div class="table-wrap position-relative">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>QR</th><th>コード</th><th>商品名</th><th>画像</th>
                <th class="text-end">価格</th><th class="text-end">在庫</th><th class="text-end">最小</th>
                <th>部門</th><th>置場</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="tbl-items"></tbody>
          </table>

          <!-- inline hover card -->
          <div id="hover-item" class="card">
            <div class="card-body" id="hover-item-body"></div>
          </div>
        </div>
      </section>

      <!-- IO -->
      <section id="view-io" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">入出庫</h5>
          <div class="d-flex gap-2">
            <button id="btn-io-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> 最近200 CSV</button>
            <button id="btn-io-import" class="btn btn-outline-secondary btn-sm"><i class="bi bi-upload"></i> インポート</button>
            <input id="input-io-import" type="file" accept=".csv" class="d-none"/>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <form id="form-io" class="row g-3">
                <div class="col-12">
                  <label class="form-label">コード</label>
                  <div class="input-group">
                    <input id="io-code" class="form-control" placeholder="ITEM|XXX または コード"/>
                    <button id="btn-io-lookup" class="btn btn-outline-secondary">検索</button>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label">数量</label>
                  <input id="io-qty" type="number" class="form-control" value="1"/>
                </div>
                <div class="col-6">
                  <label class="form-label">単位</label>
                  <input id="io-unit" class="form-control" value="pcs"/>
                </div>
                <div class="col-12">
                  <label class="form-label">種別</label>
                  <select id="io-type" class="form-select">
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                    <option value="ADJUST">ADJUST</option>
                  </select>
                </div>

                <div class="col-12">
                  <div class="row g-2">
                    <div class="col">
                      <label class="form-label">名称</label>
                      <input id="io-name" class="form-control" readonly/>
                    </div>
                    <div class="col">
                      <label class="form-label">価格</label>
                      <input id="io-price" class="form-control" readonly/>
                    </div>
                    <div class="col">
                      <label class="form-label">在庫</label>
                      <input id="io-stock" class="form-control" readonly/>
                    </div>
                  </div>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button class="btn btn-primary"><i class="bi bi-check2-circle"></i> 登録</button>
                  <button id="btn-io-scan" type="button" class="btn btn-outline-primary"><i class="bi bi-upc-scan"></i> スキャン</button>
                  <button id="btn-io-stop" type="button" class="btn btn-outline-secondary">停止</button>
                </div>
              </form>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <div class="fw-semibold mb-2">カメラ</div>
              <div id="io-scan-area">カメラ待機中…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Stocktake, Cycle, Shelf List, History, Users -->
      <!-- (bagian lain tetap, dikendalikan oleh app.js) -->
    </main>
  </div>

  <!-- Quick IN/OUT Modal -->
  <div class="modal fade" id="modal-quick-io" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick IN/OUT</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="form-quick-io" class="row g-3">
            <div class="col-12 col-lg-7">
              <label class="form-label">コード</label>
              <div class="input-group">
                <input id="qio-code" class="form-control" placeholder="スキャンまたは入力"/>
                <button id="qio-scan" type="button" class="btn btn-outline-primary"><i class="bi bi-upc-scan"></i> スキャン</button>
              </div>
              <div class="small text-muted mt-1" id="qio-preview"></div>
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label">数量</label>
              <input id="qio-qty" type="number" class="form-control" value="1"/>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">単位</label>
              <input id="qio-unit" class="form-control" value="pcs"/>
            </div>
            <div class="col-12">
              <label class="form-label me-2">種別</label>
              <div class="d-flex gap-3">
                <label class="form-check-label"><input type="radio" name="qio-type" id="qio-in" value="IN" class="form-check-input me-1" checked> IN</label>
                <label class="form-check-label"><input type="radio" name="qio-type" value="OUT" class="form-check-input me-1"> OUT</label>
                <label class="form-check-label"><input type="radio" name="qio-type" value="ADJUST" class="form-check-input me-1"> ADJUST</label>
              </div>
            </div>
            <div class="col-12">
              <div id="qio-scan-area" class="mt-2">カメラ待機中…</div>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary"><i class="bi bi-check2-circle"></i> 登録</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Loading -->
  <div id="global-loading" class="d-none">
    <div class="card p-3">
      <div class="d-flex align-items-center gap-3">
        <div class="spinner-border text-primary" role="status" style="width:2rem;height:2rem"></div>
        <div id="loading-text">読み込み中…</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          onerror="this.onerror=null;this.src='vendor/bootstrap.bundle.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Config then App -->
  <script src="config.js?v=20251107"></script>
  <script src="app.js?v=20251110a"></script>
</body>
</html>
