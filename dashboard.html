<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>在庫管理 - ダッシュボード</title>

  <!-- CSS vendor -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap.min.css'"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap-icons.css'"/>

  <!-- CSS kamu -->
  <link href="styles.css?v=20251110a" rel="stylesheet"/>
  <link href="print.css?v=20251030" rel="stylesheet"/>

  <!-- PWA & Icons (jika ada di project kamu) -->
  <link rel="icon" href="favicon.ico"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.json">

  <style>
    header.appbar{position:sticky;top:0;z-index:1020;background:#fff;border-bottom:1px solid #e5e7eb}
    header .brand{display:flex;align-items:center;gap:.6rem}
    header .brand img{height:32px}
    .layout{display:flex;min-height:100vh;gap:0;align-items:stretch}
    main{flex:1 1 auto;min-width:0}
    .content{padding:16px}
    .section-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    /* area kamera */
    #io-scan-area,#scan-area{width:100%;max-width:480px;margin:0 auto;aspect-ratio:4/3;border:1px dashed var(--bs-border-color);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#6b7280;position:relative;overflow:hidden;background:#0b0b0b10}
    #io-scan-area video,#scan-area video{width:100%!important;height:100%!important;object-fit:cover}
    .html5-qrcode-element{display:none!important}
    /* welcome banner */
    .welcome{background:linear-gradient(135deg,#eef2ff,#f5f7ff);border:1px solid #e5e7eb;border-radius:12px;
      padding:.65rem .9rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .badge-soft{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.15rem .5rem}
    /* table kecil */
    .table-items img{max-height:32px}
  </style>
</head>
<body>
  <header class="appbar py-2 px-3">
    <div class="brand">
      <img id="brand-logo" alt="logo" src="">
      <strong>在庫管理</strong>
    </div>
  </header>

  <div class="layout">
    <aside class="border-end" style="width:240px">
      <nav class="p-3 d-flex flex-column gap-2">
        <a href="#" class="btn btn-light text-start active" data-view="view-dashboard">ダッシュボード</a>
        <a href="#" class="btn btn-light text-start" data-view="view-items">商品一覧</a>
        <a href="#" class="btn btn-light text-start" data-view="view-io">入出庫</a>
        <a href="#" class="btn btn-light text-start" data-view="view-history">履歴</a>
        <a href="#" class="btn btn-light text-start" data-view="view-users">ユーザーQR</a>
        <a href="#" class="btn btn-light text-start" data-view="view-shelf">棚卸</a>
        <a href="#" class="btn btn-light text-start" data-view="view-shelf-list">棚卸一覧</a>
        <hr class="my-2">
        <button id="btn-logout" class="btn btn-outline-danger">ログアウト</button>
      </nav>
    </aside>

    <main>
      <div class="content">
        <div class="welcome mb-3" id="welcome-banner">
          ようこそ、<b id="wel-name">ユーザー</b> さん。
          <span class="badge-soft">ユーザー</span>
          <span class="text-muted small">端末、電源、電波確認しましょう。</span>
          <span class="ms-auto small text-muted" id="who"></span>
        </div>

        <h4 id="page-title" class="section-title mb-3">ダッシュボード</h4>

        <!-- ===== Dashboard ===== -->
        <section id="view-dashboard" class="active">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card p-3">
                <div class="small text-muted">総商品数</div>
                <div class="fs-3" id="metric-total-items">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card p-3">
                <div class="small text-muted">在庫少ない</div>
                <div class="fs-3" id="metric-low-stock">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card p-3">
                <div class="small text-muted">ユーザー</div>
                <div class="fs-3" id="metric-users">0</div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">月次 IN/OUT</div>
                  <button id="btn-export-mov" class="btn btn-sm btn-outline-secondary">CSV</button>
                </div>
                <div style="height:260px"><canvas id="chart-monthly"></canvas></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card p-3">
                <div class="fw-semibold">直近比率</div>
                <div style="height:260px"><canvas id="chart-pie"></canvas></div>
              </div>
            </div>
          </div>
        </section>

        <!-- ===== Items ===== -->
        <section id="view-items" class="d-none">
          <div class="items-toolbar d-flex justify-content-between align-items-center mb-2">
            <div class="left d-flex gap-2 align-items-center">
              <button id="btn-open-new-item" class="btn btn-primary btn-sm d-none"><i class="bi bi-plus-lg me-1"></i>新規</button>
              <div class="btn-group">
                <button id="btn-items-auto" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Auto</button>
                <ul class="dropdown-menu"></ul>
              </div>
            </div>
            <div class="right d-flex gap-2">
              <button id="btn-items-export" class="btn btn-sm btn-outline-secondary">CSV</button>
              <button id="btn-items-xlsx" class="btn btn-sm btn-outline-secondary">Excel</button>
              <button id="btn-items-print-all" class="btn btn-sm btn-outline-primary">全件ラベルを印刷</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-items align-middle">
              <thead>
                <tr>
                  <th></th><th>QR</th><th>コード</th><th>品名</th><th>画像</th>
                  <th class="text-end">価格</th><th class="text-end">在庫</th><th class="text-end">最小</th><th>部門</th><th>置場</th><th>操作</th>
                </tr>
              </thead>
              <tbody id="tbl-items"></tbody>
            </table>
          </div>
        </section>

        <!-- ===== 入出庫 ===== -->
        <section id="view-io" class="d-none">
          <div class="row g-3">
            <div class="col-md-5">
              <div class="card p-3">
                <div class="d-flex gap-2 mb-2">
                  <button id="btn-io-scan" class="btn btn-primary btn-sm"><i class="bi bi-camera-video me-1"></i>Scan</button>
                  <button id="btn-io-stop" class="btn btn-outline-secondary btn-sm">Stop</button>
                </div>
                <div id="io-scan-area">カメラ待機中…</div>
              </div>
            </div>
            <div class="col-md-7">
              <form id="form-io" class="card p-3">
                <div class="row g-2">
                  <div class="col-12 col-md-5">
                    <label class="form-label">コード</label>
                    <div class="input-group">
                      <input id="io-code" class="form-control" placeholder="ABC-001"/>
                      <button id="btn-io-lookup" class="btn btn-outline-secondary" type="button">照会</button>
                    </div>
                    <div class="small text-muted">ITEM|CODE または LOT|CODE|QTY(|LOTID)</div>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label">数量</label>
                    <input id="io-qty" class="form-control" inputmode="numeric"/>
                  </div>
                  <div class="col-6 col-md-2">
                    <label class="form-label">単位</label>
                    <input id="io-unit" class="form-control" value="pcs"/>
                  </div>
                  <div class="col-6 col-md-2">
                    <label class="form-label">IN/OUT</label>
                    <select id="io-type" class="form-select">
                      <option value="IN">IN</option>
                      <option value="OUT">OUT</option>
                    </select>
                  </div>
                  <!-- optional info -->
                  <div class="col-12 col-md-6">
                    <label class="form-label">品名</label>
                    <input id="io-name" class="form-control" readonly/>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label">価格</label>
                    <input id="io-price" class="form-control" readonly/>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label">在庫</label>
                    <input id="io-stock" class="form-control" readonly/>
                  </div>
                  <div class="col-12">
                    <label class="form-label">備考</label>
                    <input id="io-note" class="form-control"/>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> 登録</button>
                  <button id="btn-io-clear" type="reset" class="btn btn-outline-secondary">クリア</button>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- ===== 履歴 ===== -->
        <section id="view-history" class="d-none">
          <div class="items-toolbar d-flex justify-content-between align-items-center mb-2">
            <div></div>
            <div class="right d-flex gap-2">
              <button id="btn-io-export" class="btn btn-sm btn-outline-secondary">CSV</button>
              <input id="input-io-import" type="file" accept=".csv" hidden>
              <button id="btn-io-import" class="btn btn-sm btn-outline-secondary">Import CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
              <tr>
                <th>日時</th><th>ユーザー</th><th>名前</th><th>コード</th><th>品名</th><th class="text-end">数量</th><th>単位</th><th>種別</th><th>備考</th><th></th>
              </tr>
              </thead>
              <tbody id="tbl-history"></tbody>
            </table>
          </div>
        </section>

        <!-- ===== ユーザー QR ===== -->
        <section id="view-users" class="d-none">
          <div class="items-toolbar d-flex justify-content-between align-items-center mb-2">
            <div class="left d-flex gap-2 align-items-center">
              <button id="btn-open-new-user" class="btn btn-primary btn-sm d-none"><i class="bi bi-plus-lg me-1"></i>新規</button>
            </div>
            <div class="right d-flex gap-2">
              <button id="btn-users-export" class="btn btn-sm btn-outline-secondary d-none">CSV</button>
              <button id="btn-users-import" class="btn btn-sm btn-outline-secondary d-none">Import CSV</button>
              <input id="input-users-import" type="file" accept=".csv" hidden>
              <button id="btn-print-qr-users" class="btn btn-sm btn-outline-primary">印刷</button>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-lg-7">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead><tr><th>QR</th><th>ID</th><th>氏名</th><th>権限</th><th class="text-end">DL</th></tr></thead>
                  <tbody id="tbl-userqr"></tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-5">
              <div id="print-qr-users-grid" class="card p-3 h-100 d-flex align-items-center justify-content-center text-muted small">
                選択中のユーザーQRがここに表示されます。
              </div>
            </div>
          </div>
        </section>

        <!-- ===== 棚卸（入力） ===== -->
        <section id="view-shelf" class="d-none">
          <div class="items-toolbar d-flex justify-content-between align-items-center mb-2">
            <div class="left d-flex gap-2">
              <button id="btn-start-scan" class="btn btn-primary btn-sm"><i class="bi bi-camera-video me-1"></i>Scan</button>
              <button id="btn-stop-scan" class="btn btn-outline-secondary btn-sm">Stop</button>
            </div>
            <div class="right d-flex gap-2"></div>
          </div>

          <div class="row g-3">
            <div class="col-md-5">
              <div id="scan-area" class="card p-3">カメラ待機中…</div>
              <div class="mt-2 d-flex gap-2">
                <input id="st-code" class="form-control" placeholder="CODE">
                <input id="st-qty" class="form-control" placeholder="数量">
                <button id="st-add" class="btn btn-outline-primary">追加</button>
              </div>
              <div class="mt-2">
                <input id="st-filter" class="form-control" placeholder="コード/品名でフィルタ">
              </div>
            </div>
            <div class="col-md-7">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead><tr><th>コード</th><th>品名</th><th>部門</th><th class="text-end">帳簿</th><th class="text-end">実数</th><th class="text-end">差異</th><th class="text-end">操作</th></tr></thead>
                  <tbody id="tbl-stocktake"></tbody>
                </table>
              </div>
              <div id="st-summary" class="small text-muted mt-2"></div>
            </div>
          </div>
        </section>

        <!-- ===== 棚卸一覧 ===== -->
        <section id="view-shelf-list" class="d-none">
          <div class="items-toolbar d-flex justify-content-between align-items-center mb-2">
            <div class="left d-flex gap-2">
              <button id="tana-recap-export-monthly" class="btn btn-sm btn-outline-secondary">月次CSV</button>
              <button id="tana-recap-export-yearly" class="btn btn-sm btn-outline-secondary">年次CSV</button>
            </div>
            <div class="right d-flex gap-2">
              <button id="tana-exp" class="btn btn-sm btn-outline-secondary">CSV</button>
              <input id="input-tana-imp" type="file" accept=".csv" hidden>
              <button id="tana-matome-exp" class="btn btn-sm btn-outline-secondary">コード別集計</button>
            </div>
          </div>
          <div class="table-responsive">
            <table id="tbl-tana" class="table table-sm align-middle"></table>
          </div>
        </section>

        <!-- Global loading (digunakan app.js) -->
        <div id="global-loading" class="d-none position-fixed top-0 start-0 w-100 h-100" style="background:rgba(255,255,255,.6);z-index:2000;display:grid;place-items:center">
          <div class="card p-3">
            <div id="loading-text">読み込み中…</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== Scripts: vendor urutan wajib ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- QRCode: PASTIKAN hanya sekali -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Config dulu, baru app -->
  <script src="config.js"></script>
  <script src="app.js"></script>
</body>
</html>
