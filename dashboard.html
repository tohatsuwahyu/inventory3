<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>在庫コントロール・ダッシュボード</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom styles -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="print.css" media="print">

  <style>
    /* ========= LIGHT & SOFT THEME ========= */
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#263238;
      --muted:#6b7a8a;
      --border:#e6ecf2;
      --accent:#4f8ef7;
      --accent-soft:#e8f1ff;
    }
    body{ background:var(--bg); color:var(--ink); }
    header.navbar{
      background:#ffffff;
      border-bottom:1px solid var(--border);
    }
    .brand{ display:flex; align-items:center; gap:.5rem; font-weight:700; letter-spacing:.2px; color:var(--ink) }
    .brand img{ width:28px; height:28px; filter:drop-shadow(0 0 10px rgba(79,142,247,.25)); }

    .sidebar{
      width:260px; background:#ffffff; border-right:1px solid var(--border);
      position:fixed; top:56px; bottom:0; left:0; padding:12px 8px; overflow:auto;
    }
    .sidebar a{
      display:flex; align-items:center; gap:.6rem; color:var(--muted);
      text-decoration:none; padding:.56rem .8rem; border-radius:.65rem; font-weight:600;
    }
    .sidebar a.active, .sidebar a:hover{
      background:var(--accent-soft); color:var(--accent);
    }
    main{ margin-left:260px; padding:16px; }
    @media (max-width:991.98px){
      .sidebar{ transform:translateX(-100%); transition:.25s; z-index:1050 }
      .sidebar.open{ transform:none }
      main{ margin-left:0; }
    }
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; }
    .drawer-backdrop.show{ display:block }

    .metric{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 6px 20px rgba(28,60,107,.06);
    }
    .metric .title{ color:var(--muted); font-size:.92rem }
    .glow-card{ box-shadow:0 8px 24px rgba(28,60,107,.08) }

    .table thead th{ color:#7b8ea4; font-weight:700; border-bottom:1px solid var(--border) }
    .table> :not(caption)>*>*{ background:transparent !important; }
    .table tr:hover{ background:#f3f7ff !important; cursor:pointer }

    .qrbox{ display:flex; flex-direction:column; align-items:center; gap:.25rem }
    .qrbox .caption{ font-size:.78rem; color:#7b8ea4; max-width:160px; text-align:center }
    .thumb{ width:56px; height:40px; object-fit:cover; border-radius:8px; border:1px solid var(--border) }

    .card .card-header{ background:transparent; border-bottom:1px solid var(--border) }
    .btn-outline-secondary, .btn-outline-primary, .btn-outline-danger{
      --bs-btn-border-color:#cdd9e6;
      --bs-btn-hover-bg:#f3f7ff;
      --bs-btn-color:#37506e;
    }

    .badge-soft{ background:var(--accent-soft); color:var(--accent); border:1px solid #d9e6ff }
    @media print{ .d-none-print{ display:none !important } }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="navbar sticky-top px-3">
    <div class="d-flex align-items-center gap-2">
      <button id="burger" class="btn btn-sm btn-outline-secondary d-lg-none d-inline-flex align-items-center"><i class="bi bi-list"></i></button>
      <div class="brand">
        <img id="brand-logo" src="" alt="logo">
        <span>Inventory Control</span>
      </div>
    </div>
    <div class="ms-auto d-flex align-items-center gap-3">
      <div class="small text-muted">ログイン: <span id="who">—</span></div>
      <button id="btn-logout" class="btn btn-sm btn-outline-secondary"><i class="bi bi-box-arrow-right me-1"></i> ログアウト</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside id="sb" class="sidebar d-none-print">
    <nav class="d-flex flex-column gap-1">
      <a data-view="view-dashboard" class="active"><i class="bi bi-grid-1x2"></i> ダッシュボード</a>
      <a data-view="view-io"><i class="bi bi-arrow-left-right"></i> 入出庫</a>
      <a data-view="view-items"><i class="bi bi-box-seam"></i> 商品一覧</a>
      <a data-view="view-users"><i class="bi bi-qr-code"></i> ユーザー / QR</a>
      <a data-view="view-history"><i class="bi bi-clock-history"></i> 履歴</a>
      <a data-view="view-stocktake"><i class="bi bi-clipboard-check"></i> 棚卸</a>
    </nav>
  </aside>
  <div id="sb-backdrop" class="drawer-backdrop"></div>

  <!-- Main -->
  <main class="container-fluid">
    <h4 class="mb-3" id="page-title">ダッシュボード</h4>

    <!-- DASHBOARD -->
    <section id="view-dashboard">
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <div class="card metric glow-card p-3">
            <div class="title">総アイテム</div>
            <div class="fs-2 fw-bold" id="metric-total-items">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card metric glow-card p-3">
            <div class="title">最小在庫以下</div>
            <div class="fs-2 fw-bold text-warning" id="metric-low-stock">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card metric glow-card p-3">
            <div class="title">ユーザー</div>
            <div class="fs-2 fw-bold" id="metric-users">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card metric glow-card p-3">
            <div class="title">直近30日の取引</div>
            <div class="fs-2 fw-bold" id="metric-txn">—</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-lg-8">
          <div class="card metric p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">月次 IN/OUT</div>
            </div>
            <canvas id="chart-monthly" height="120"></canvas>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card metric p-3">
            <div class="fw-semibold">今月の比率</div>
            <canvas id="chart-pie" height="160"></canvas>
          </div>
        </div>
      </div>

      <div class="card metric p-3 mt-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">今月の入出庫（商品別）</div>
          <button id="btn-export-mov" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead>
              <tr><th>コード</th><th>名称</th><th class="text-end">IN</th><th class="text-end">OUT</th><th class="text-end">NET</th></tr>
            </thead>
            <tbody id="tbl-mov"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 入出庫 -->
    <section id="view-io" class="d-none">
      <div class="card metric p-3">
        <div class="fw-semibold mb-2">入出庫</div>
        <form id="form-io" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">コード</label>
            <div class="input-group">
              <input id="io-code" class="form-control" required>
              <button id="btn-io-lookup" class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i> 照会
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">名称</label>
            <input id="io-name" class="form-control" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">在庫</label>
            <input id="io-stock" class="form-control" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">価格</label>
            <input id="io-price" class="form-control" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">数量</label>
            <input id="io-qty" type="number" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">単位</label>
            <input id="io-unit" class="form-control" value="pcs">
          </div>
          <div class="col-md-2">
            <label class="form-label">種別</label>
            <select id="io-type" class="form-select">
              <option value="IN">IN</option>
              <option value="OUT">OUT</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100"><i class="bi bi-check2-circle me-1"></i> 登録</button>
          </div>
        </form>

        <hr class="my-4">

        <div class="row">
          <div class="col-lg-6">
            <div class="small text-muted mb-1">カメラでスキャン（入出庫）</div>
            <div id="io-scan-area" style="width:100%;max-width:420px"></div>
            <div class="mt-2 d-flex gap-2">
              <button id="btn-io-start" class="btn btn-sm btn-outline-secondary" onclick="startIoScan()"><i class="bi bi-camera-video"></i> スタート</button>
              <button id="btn-io-stop" class="btn btn-sm btn-outline-secondary" onclick="stopIoScan()"><i class="bi bi-camera-video-off"></i> ストップ</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 商品一覧 -->
    <section id="view-items" class="d-none">
      <div class="card metric p-3">
        <div class="d-flex align-items-center gap-2">
          <div class="fw-semibold">商品一覧</div>
          <div class="ms-auto" style="min-width:240px">
            <input id="items-filter" class="form-control form-control-sm" placeholder="名称で絞り込み…">
          </div>
          <div class="d-flex gap-2">
            <button id="btn-items-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
            <button id="btn-items-xlsx" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
            <button id="btn-open-new-item" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i> 新規</button>
          </div>
        </div>

        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>QR</th><th>コード</th><th>名称</th><th>置場</th><th>画像</th>
                <th class="text-end">価格</th><th class="text-end">在庫</th><th class="text-end">最小</th><th class="text-end">操作</th>
              </tr>
            </thead>
            <tbody id="tbl-items"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 商品詳細 -->
    <section id="view-item-detail" class="d-none">
      <div class="card metric p-3 mb-3">
        <div class="d-flex align-items-center gap-3">
          <img id="det-img" class="rounded d-none" style="width:96px;height:72px;object-fit:cover" alt="">
          <div>
            <div class="fw-semibold fs-5" id="det-name">—</div>
            <div class="text-muted small">コード: <span id="det-code"></span>・ 置場: <span id="det-loc"></span></div>
          </div>
          <div class="ms-auto text-end">
            <div>価格: <span id="det-price"></span></div>
            <div>在庫: <span id="det-stock"></span>（最小 <span id="det-min"></span>）</div>
            <div>ロット: <span id="det-lot"></span> / バーコード: <span id="det-bar"></span></div>
          </div>
        </div>
      </div>
      <div class="card metric p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">この商品の履歴</div>
          <button id="btn-det-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr><th>日時</th><th>ユーザー</th><th class="text-end">数量</th><th>単位</th><th>種別</th><th class="text-end">編集</th></tr></thead>
            <tbody id="tbl-item-history"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ユーザー / QR -->
    <section id="view-users" class="d-none">
      <div class="card metric p-3">
        <div class="d-flex align-items-center gap-2">
          <div class="fw-semibold">ユーザー / QR</div>
          <div class="ms-auto d-flex gap-2">
            <span class="badge badge-soft d-none" id="users-tip">admin only</span>
            <button id="btn-open-new-user" class="btn btn-sm btn-primary d-none"><i class="bi bi-person-plus me-1"></i> 新規ユーザー</button>
            <button id="btn-print-qr-users" class="btn btn-sm btn-outline-secondary d-none"><i class="bi bi-printer me-1"></i> 印刷（A4）</button>
          </div>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr><th>QR</th><th>ID</th><th>氏名</th><th>権限</th><th class="text-end">DL</th></tr></thead>
            <tbody id="tbl-userqr"></tbody>
          </table>
        </div>
      </div>

      <!-- Print sheet -->
      <div id="print-qr-users" class="d-none">
        <div class="container py-4">
          <h5 class="mb-3">ユーザーQR</h5>
          <div id="print-qr-users-grid" class="d-grid" style="grid-template-columns: repeat(3, 1fr); gap: 16px"></div>
        </div>
      </div>
    </section>

    <!-- 履歴 -->
    <section id="view-history" class="d-none">
      <div class="card metric p-3">
        <div class="fw-semibold mb-2">入出庫履歴</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr><th>日時</th><th>ユーザー</th><th>コード</th><th class="text-end">数量</th><th>単位</th><th>種別</th><th class="text-end">編集</th></tr>
            </thead>
            <tbody id="tbl-history"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 棚卸 -->
    <section id="view-stocktake" class="d-none">
      <div class="card metric p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">棚卸</div>
          <div class="d-flex gap-2">
            <button id="btn-start-scan" class="btn btn-sm btn-outline-secondary"><i class="bi bi-qr-code-scan me-1"></i> スキャン開始</button>
            <button id="btn-stop-scan" class="btn btn-sm btn-outline-secondary"><i class="bi bi-stop-circle me-1"></i> 停止</button>
            <button id="st-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-6">
            <div id="scan-area" style="width:100%;max-width:420px"></div>
          </div>
          <div class="col-lg-6">
            <form class="row g-2">
              <div class="col-6">
                <label class="form-label">コード</label>
                <input id="st-code" class="form-control">
              </div>
              <div class="col-6">
                <label class="form-label">実在庫（数量）</label>
                <input id="st-qty" type="number" class="form-control">
              </div>
              <div class="col-12">
                <button id="st-add" class="btn btn-primary w-100"><i class="bi bi-plus-circle me-1"></i> 追加</button>
              </div>
            </form>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>コード</th><th>名称</th><th class="text-end">帳簿</th><th class="text-end">実在庫</th><th class="text-end">差異</th></tr></thead>
            <tbody id="tbl-stocktake"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== Modals ===== -->

    <!-- 新規 商品 -->
    <div class="modal fade" id="dlg-new-item" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header"><h6 class="modal-title">商品 登録 / 更新</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="form-item" class="row g-3">
              <div class="col-md-3"><label class="form-label">コード</label><input id="i-code" class="form-control" required></div>
              <div class="col-md-5"><label class="form-label">名称</label><input id="i-name" class="form-control" required></div>
              <div class="col-md-2"><label class="form-label">価格</label><input id="i-price" type="number" class="form-control" value="0"></div>
              <div class="col-md-2"><label class="form-label">最小在庫</label><input id="i-min" type="number" class="form-control" value="0"></div>

              <div class="col-md-2"><label class="form-label">在庫</label><input id="i-stock" type="number" class="form-control" value="0"></div>
              <div class="col-md-6"><label class="form-label">画像URL</label><input id="i-img" class="form-control"></div>
              <div class="col-md-4"><label class="form-label">置場</label><input id="i-location" class="form-control" placeholder="A-01 等"></div>

              <div class="col-md-4"><label class="form-label">ロットあたり数量</label><input id="i-lot" type="number" class="form-control" value="0" placeholder="1箱=10/20 等"></div>
              <div class="col-md-4"><label class="form-label">バーコード（任意）</label><input id="i-barcode" class="form-control" placeholder="EAN/Code128"></div>

              <input type="hidden" id="i-overwrite-flag" value="">
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> 保存</button>
                <button id="btn-item-makeqr" type="button" class="btn btn-outline-secondary"><i class="bi bi-qr-code me-1"></i> QRプレビュー</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 新規 ユーザー -->
    <div class="modal fade" id="dlg-new-user" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h6 class="modal-title">ユーザー登録</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="form-user" class="row g-3">
              <div class="col-md-6"><label class="form-label">氏名</label><input id="u-name" class="form-control" required></div>
              <div class="col-md-6"><label class="form-label">ID</label><input id="u-id" class="form-control" required></div>
              <div class="col-md-6">
                <label class="form-label">権限</label>
                <select id="u-role" class="form-select"><option value="user">user</option><option value="admin">admin</option></select>
              </div>
              <div class="col-md-6"><label class="form-label">PIN（任意）</label><input id="u-pin" class="form-control" placeholder="数字"></div>
              <div class="col-12"><button class="btn btn-primary w-100"><i class="bi bi-check2"></i> 登録</button></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 履歴 編集 -->
    <div class="modal fade" id="dlg-edit-history" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">履歴を編集</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="form-edit-history" class="row g-3">
            <input type="hidden" id="eh-row">
            <div class="col-md-4"><label class="form-label">コード</label><input id="eh-code" class="form-control" required></div>
            <div class="col-md-3"><label class="form-label">数量</label><input id="eh-qty" type="number" class="form-control" required></div>
            <div class="col-md-3"><label class="form-label">単位</label><input id="eh-unit" class="form-control" value="pcs"></div>
            <div class="col-md-2">
              <label class="form-label">種別</label>
              <select id="eh-type" class="form-select"><option>IN</option><option>OUT</option></select>
            </div>
            <div class="col-12"><button class="btn btn-primary w-100"><i class="bi bi-check2-circle me-1"></i> 更新</button></div>
          </form>
        </div>
      </div></div>
    </div>

  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- QR library (local) -->
  <script src="qrlib.js"></script>

  <!-- Config & App -->
  <script src="config.js"></script>
 <script src="app.compat.js?v=5" defer></script>


</body>
</html>
