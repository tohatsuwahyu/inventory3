<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>在庫管理 - ダッシュボード</title>

  <!-- Bootstrap CSS (CDN, lalu fallback lokal jika gagal) -->
  <link id="bs-css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap.min.css'"/>
  <!-- Bootstrap Icons (CDN → lokal) -->
  <link id="bs-icons" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap-icons.css'"/>

  <!-- App styles -->
  <link href="styles.css" rel="stylesheet"/>
  <link href="print.css" rel="stylesheet"/>
  <style>
    header.appbar{ position:sticky; top:0; z-index:1020; background:#fff; border-bottom:1px solid #e5e7eb; }
    header .brand{ display:flex; align-items:center; gap:.6rem; }
    header .brand img{ height:32px; }
    .sidebar{ min-width:240px; max-width:260px; padding:14px; }
    @media (max-width:992px){
      .layout{ display:block; }
      .sidebar{ position:fixed; left:0; top:0; bottom:0; transform:translateX(-100%); transition:.2s; width:82%; max-width:320px; z-index:1040; }
      .sidebar.open{ transform:none; }
      #sb-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; z-index:1030;}
      #sb-backdrop.show{ display:block; }
    }
    main{ flex:1; }
    .layout{ display:flex; min-height:100vh; gap:0; }
    .content{ padding:16px; }
  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="container-fluid py-2">
      <div class="d-flex align-items-center justify-content-between">
        <div class="brand">
          <button id="burger" class="btn btn-outline-secondary d-lg-none"><i class="bi bi-list"></i></button>
          <img id="brand-logo" alt="logo"/>
          <div class="fw-bold">在庫管理</div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <span id="who" class="text-muted small">user</span>
          <button id="btn-logout" class="btn btn-sm btn-outline-secondary">ログアウト</button>
        </div>
      </div>
    </div>
  </header>

  <div id="sb-backdrop"></div>

  <div class="layout">
    <!-- Sidebar -->
    <aside id="sb" class="sidebar">
      <nav class="d-flex flex-column gap-1">
        <a data-view="view-dashboard" class="active"><i class="bi bi-speedometer2"></i> ダッシュボード</a>
        <a data-view="view-io"><i class="bi bi-box-seam"></i> 入出庫（QR対応）</a>
        <a data-view="view-shelf"><i class="bi bi-clipboard-check"></i> 棚卸</a>
        <a data-view="view-items"><i class="bi bi-boxes"></i> 商品一覧</a>
        <a data-view="view-users"><i class="bi bi-person-badge"></i> ユーザー / QR</a>
        <a data-view="view-history"><i class="bi bi-clock-history"></i> 履歴</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="w-100">
      <div class="content container-fluid">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 id="page-title" class="section-title m-0">ダッシュボード</h5>
          <button id="btn-menu" class="btn btn-outline-secondary d-lg-none">メニュー</button>
        </div>

        <!-- ========= Dashboard ========= -->
        <section id="view-dashboard" class="active">
          <div class="row g-3 mb-3">
            <div class="col-md-3"><div class="card p-3">
              <div class="text-muted small"><i class="bi bi-boxes me-1"></i>アイテム数</div>
              <div id="metric-total-items" class="fs-3 fw-bold text-primary">0</div>
            </div></div>
            <div class="col-md-3"><div class="card p-3">
              <div class="text-muted small"><i class="bi bi-graph-down-arrow me-1"></i>最小在庫以下</div>
              <div id="metric-low-stock" class="fs-3 fw-bold text-danger">0</div>
            </div></div>
            <div class="col-md-3"><div class="card p-3">
              <div class="text-muted small"><i class="bi bi-people me-1"></i>ユーザー</div>
              <div id="metric-users" class="fs-3 fw-bold text-success">0</div>
            </div></div>
            <div class="col-md-3"><div class="card p-3">
              <div class="text-muted small"><i class="bi bi-arrow-left-right me-1"></i>直近30日の取引</div>
              <div id="metric-txn" class="fs-3 fw-bold text-info">0</div>
            </div></div>
          </div>

          <div class="row g-3">
            <div class="col-lg-8">
              <div class="card p-3">
                <div class="text-muted small mb-2">月次 IN/OUT</div>
                <canvas id="chart-monthly" height="140"></canvas>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card p-3">
                <div class="text-muted small mb-2">当月比率</div>
                <canvas id="chart-pie" height="140"></canvas>
              </div>
            </div>
          </div>

          <div class="card p-3 mt-3">
            <div class="d-flex items-toolbar">
              <div class="left"><div class="fw-semibold">当月アイテム別の動き</div></div>
              <div class="right">
                <button id="btn-export-mov" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-filetype-csv me-1"></i>CSV
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>コード</th><th>名称</th><th class="text-end">IN</th><th class="text-end">OUT</th><th class="text-end">NET</th></tr></thead>
                <tbody id="tbl-mov"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ========= 入出庫 ========= -->
        <section id="view-io" class="d-none">
          <div class="card p-3 mb-3">
            <div class="items-toolbar">
              <div class="left"><div class="fw-semibold">スキャン</div></div>
              <div class="right">
                <button id="btn-io-scan" class="btn btn-sm btn-primary"><i class="bi bi-camera-video me-1"></i> 開始</button>
                <button id="btn-io-stop" class="btn btn-sm btn-outline-secondary">停止</button>
              </div>
            </div>
            <div id="io-scan-area" class="border rounded p-3 text-center text-muted">カメラ待機中…</div>
          </div>

          <div class="card p-3">
            <div class="items-toolbar">
              <div class="left"><div class="fw-semibold">入出庫入力</div></div>
              <div class="right">
                <button id="btn-io-lookup" class="btn btn-sm btn-outline-secondary"><i class="bi bi-search me-1"></i>照会</button>
              </div>
            </div>
            <form id="form-io" class="row g-3">
              <div class="col-md-4"><label class="form-label">コード</label><input id="io-code" class="form-control"/></div>
              <div class="col-md-4"><label class="form-label">名称</label><input id="io-name" class="form-control" readonly/></div>
              <div class="col-md-2"><label class="form-label">価格</label><input id="io-price" class="form-control" readonly/></div>
              <div class="col-md-2"><label class="form-label">在庫</label><input id="io-stock" class="form-control" readonly/></div>
              <div class="col-md-3"><label class="form-label">数量</label><input id="io-qty" type="number" class="form-control" required/></div>
              <div class="col-md-3"><label class="form-label">単位</label>
                <select id="io-unit" class="form-select"><option>pcs</option><option>kg</option><option>m</option></select>
              </div>
              <div class="col-md-3"><label class="form-label">種別</label>
                <select id="io-type" class="form-select"><option>IN</option><option>OUT</option></select>
              </div>
              <div class="col-12"><button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> 登録</button></div>
            </form>
          </div>
        </section>

        <!-- ========= 棚卸 ========= -->
        <section id="view-shelf" class="d-none">
          <div class="card p-3 mb-3">
            <div class="items-toolbar">
              <div class="left"><div class="fw-semibold">スキャン</div></div>
              <div class="right">
                <button id="btn-start-scan" class="btn btn-sm btn-primary"><i class="bi bi-camera-video me-1"></i> 開始</button>
                <button id="btn-stop-scan" class="btn btn-sm btn-outline-secondary">停止</button>
              </div>
            </div>
            <div id="scan-area" class="border rounded p-3 text-center text-muted">カメラ待機中…</div>
          </div>

          <div class="card p-3">
            <div class="items-toolbar">
              <div class="left"><div class="fw-semibold">手入力</div></div>
              <div class="right">
                <button id="st-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
              </div>
            </div>
            <div class="row g-3 mb-2">
              <div class="col-md-4"><label class="form-label">コード</label><input id="st-code" class="form-control"/></div>
              <div class="col-md-3"><label class="form-label">実在数量</label><input id="st-qty" type="number" class="form-control"/></div>
              <div class="col-md-2 d-flex align-items-end"><button id="st-add" class="btn btn-primary w-100">追加</button></div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>コード</th><th>名称</th><th class="text-end">帳簿</th><th class="text-end">実在</th><th class="text-end">差異</th></tr></thead>
                <tbody id="tbl-stocktake"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ========= 商品一覧 ========= -->
        <section id="view-items" class="d-none">
          <div class="items-toolbar card p-3 mb-3">
            <div class="left gap-6">
              <div class="fw-semibold">商品一覧</div>
              <input id="items-search" class="form-control search" placeholder="名称で検索…"/>
            </div>
            <div class="right">
              <button id="btn-items-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
              <button id="btn-items-xlsx" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-excel me-1"></i>Excel</button>
              <button id="btn-items-print-all" class="btn btn-sm btn-outline-secondary"><i class="bi bi-printer me-1"></i> 全件ラベルを印刷</button>
              <button id="btn-open-new-item" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i> 新規</button>
            </div>
          </div>

          <div class="card p-3">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="width:170px">QR</th>
                    <th>コード</th>
                    <th>名称</th>
                    <th>画像</th>
                    <th class="text-end">価格</th>
                    <th class="text-end">在庫</th>
                    <th class="text-end">最小</th>
                    <th>置場</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody id="tbl-items"></tbody>
              </table>
            </div>

            <!-- 詳細パネル -->
            <div id="card-item-detail" class="card p-3 mt-3 d-none">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">詳細</div>
                <button id="btn-close-detail" class="btn btn-sm btn-outline-secondary">閉じる</button>
              </div>
              <div id="item-detail-body"></div>
            </div>
          </div>
        </section>

        <!-- ========= ユーザー / QR ========= -->
        <section id="view-users" class="d-none">
          <div class="items-toolbar card p-3 mb-3">
            <div class="left"><div class="fw-semibold">ユーザー / QR</div></div>
            <div class="right">
              <button id="btn-print-qr-users" class="btn btn-sm btn-outline-secondary d-none"><i class="bi bi-printer me-1"></i> 印刷</button>
              <button id="btn-open-new-user" class="btn btn-sm btn-primary d-none"><i class="bi bi-plus-circle me-1"></i> 新規ユーザー</button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-7"><div class="card p-3">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead><tr><th style="width:170px">QR</th><th>ID</th><th>名前</th><th>権限</th><th class="text-end">DL</th></tr></thead>
                  <tbody id="tbl-userqr"></tbody>
                </table>
              </div>
            </div></div>
            <div class="col-lg-5"><div class="card p-3">
              <div class="fw-semibold mb-2">印刷プレビュー</div>
              <div id="print-qr-users-grid" class="d-flex flex-wrap gap-2"></div>
            </div></div>
          </div>
        </section>

        <!-- ========= 履歴 ========= -->
        <section id="view-history" class="d-none">
          <div class="items-toolbar card p-3 mb-3">
            <div class="left"><div class="fw-semibold">履歴</div></div>
            <div class="right"><span class="badge-soft">最新400件を表示</span></div>
          </div>

          <div class="card p-3">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>日時</th><th>ユーザーID</th><th>ユーザー名</th>
                    <th>コード</th><th>名称</th><th class="text-end">数量</th><th>単位</th><th>種別</th><th>備考</th><th>修正</th>
                  </tr>
                </thead>
                <tbody id="tbl-history"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== Modals (Item/User/History) ===== -->
  <!-- New Item -->
  <div class="modal fade" id="dlg-new-item" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form id="form-item" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">新規商品</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">コード</label><input id="i-code" class="form-control" required/></div>
            <div class="col-md-8"><label class="form-label">名称</label><input id="i-name" class="form-control" required/></div>
            <div class="col-md-4"><label class="form-label">価格</label><input id="i-price" type="number" class="form-control" value="0"/></div>
            <div class="col-md-4"><label class="form-label">在庫</label><input id="i-stock" type="number" class="form-control" value="0"/></div>
            <div class="col-md-4"><label class="form-label">最小</label><input id="i-min" type="number" class="form-control" value="0"/></div>
            <div class="col-md-8"><label class="form-label">画像URL</label><input id="i-img" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">置場</label><input id="i-location" class="form-control"/></div>
            <div class="col-md-6"><label class="form-label">ロット単位</label><input id="i-lotUnit" class="form-control" value="pcs"/></div>
            <div class="col-md-6"><label class="form-label">ロット数量</label><input id="i-lotQty" type="number" class="form-control" value="0"/></div>
          </div>
          <div class="mt-3"><button type="button" id="btn-item-makeqr" class="btn btn-outline-secondary"><i class="bi bi-qr-code me-1"></i>QRプレビュー</button></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary">保存</button></div>
      </form>
    </div>
  </div>

  <!-- Edit Item -->
  <div class="modal fade" id="dlg-edit-item" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form id="form-edit-item" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">商品編集</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">コード</label><input id="e-code" class="form-control" readonly/></div>
            <div class="col-md-8"><label class="form-label">名称</label><input id="e-name" class="form-control" required/></div>
            <div class="col-md-4"><label class="form-label">価格</label><input id="e-price" type="number" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">在庫</label><input id="e-stock" type="number" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">最小</label><input id="e-min" type="number" class="form-control"/></div>
            <div class="col-md-8"><label class="form-label">画像URL</label><input id="e-img" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">置場</label><input id="e-location" class="form-control"/></div>
            <div class="col-md-6"><label class="form-label">ロット単位</label><input id="e-lotUnit" class="form-control"/></div>
            <div class="col-md-6"><label class="form-label">ロット数量</label><input id="e-lotQty" type="number" class="form-control"/></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary">保存</button></div>
      </form>
    </div>
  </div>

  <!-- New User -->
  <div class="modal fade" id="dlg-new-user" tabindex="-1">
    <div class="modal-dialog">
      <form id="form-user" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">新規ユーザー</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">名前</label><input id="u-name" class="form-control" required/></div>
            <div class="col-md-6"><label class="form-label">ID</label><input id="u-id" class="form-control" required/></div>
            <div class="col-md-6"><label class="form-label">権限</label>
              <select id="u-role" class="form-select"><option value="user">user</option><option value="admin">admin</option></select>
            </div>
            <div class="col-md-6"><label class="form-label">PIN</label><input id="u-pin" class="form-control"/></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary">保存</button></div>
      </form>
    </div>
  </div>

  <!-- Edit History -->
  <div class="modal fade" id="dlg-edit-history" tabindex="-1">
    <div class="modal-dialog">
      <form id="form-history" class="modal-content">
        <div class="modal-header"><h6 class="modal-title">履歴修正</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="h-row"/>
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">ユーザーID</label><input id="h-userId" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">コード</label><input id="h-code" class="form-control"/></div>
            <div class="col-md-4"><label class="form-label">数量</label><input id="h-qty" type="number" class="form-control"/></div>
            <div class="col-md-6"><label class="form-label">単位</label><input id="h-unit" class="form-control" value="pcs"/></div>
            <div class="col-md-6"><label class="form-label">種別</label><select id="h-type" class="form-select"><option>IN</option><option>OUT</option></select></div>
            <div class="col-12"><label class="form-label">備考</label><input id="h-note" class="form-control"/></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" data-bs-dismiss="modal">保存</button></div>
      </form>
    </div>
  </div>

  <!-- ===== Global Loading Overlay ===== -->
  <div id="global-loading" class="d-none">
    <div class="box">
      <div class="spinner"></div>
      <div id="loading-text" class="text">読み込み中…</div>
    </div>
  </div>

  <!-- ===== Core Libraries (CDN → fallback lokal via onerror) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          onerror="this.onerror=null;this.src='vendor/bootstrap.bundle.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
          onerror="this.onerror=null;this.src='vendor/chart.umd.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
          onerror="this.onerror=null;this.src='vendor/xlsx.full.min.js'"></script>

  <!-- QRCode generator (rename file ini jadi qrlib.js) -->
<script src="qrlib.js"></script>

<!-- Scanner html5-qrcode: pakai vendor saja -->
<script src="vendor/html5-qrcode.min.js"></script>

<!-- Config & App (WAJIB terakhir) -->
<script src="config.js"></script>
<script src="app.js"></script>

</body>
</html>
