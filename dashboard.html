<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>在庫管理 - ダッシュボード</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap.min.css'"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap-icons.css'"/>

  <!-- App styles -->
  <link href="styles.css?v=20251107" rel="stylesheet"/>
  <link href="print.css?v=20251030" rel="stylesheet"/>

  <style>
    :root{ --appbar-h:56px; }
    body{ background:#f6f8fc; }

    /* Appbar */
    header.appbar{
      position:sticky; top:0; z-index:1020; background:#fff;
      border-bottom:1px solid #e5e7eb; height:var(--appbar-h);
      display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem;
    }
    .brand{ display:flex; align-items:center; gap:.5rem; }
    .brand img{ height:28px; }
    .brand .ttl{ font-weight:600; color:#0f172a; }
    .appbar-actions{ margin-left:auto; display:flex; align-items:center; gap:.5rem; }

    /* Layout */
    .app-layout{ display:grid; grid-template-columns:240px 1fr; min-height:calc(100dvh - var(--appbar-h)); }
    aside{ background:#fff; border-right:1px solid #e5e7eb; }
    aside .menu{ padding:.75rem; }
    aside .menu a{ display:flex; gap:.5rem; align-items:center; padding:.5rem .75rem; border-radius:.5rem; color:#0f172a; text-decoration:none; }
    aside .menu a.active, aside .menu a:hover{ background:#eef2ff; }
    main{ padding:1rem; }

    /* Sidebar overlay (mobile) */
    #sb-backdrop{ display:none; }
    .sb-open #sb-backdrop{ display:block; position:fixed; inset:0; background:rgba(15,23,42,.25); z-index:1010; }
    @media (max-width: 992px){
      .app-layout{ grid-template-columns:0 1fr; }
      aside{ position:fixed; z-index:1025; top:var(--appbar-h); bottom:0; width:260px; transform:translateX(-100%); transition:.2s; }
      .sb-open aside{ transform:none; }
    }

    /* Global search dropdown */
    #global-search-wrap{ position:relative; flex:1; max-width:520px; }
    #global-search-results{
      position:absolute; left:0; right:0; top:100%; z-index:1050; display:none;
      background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; margin-top:.25rem; overflow:hidden;
      box-shadow:0 6px 24px rgba(15,23,42,.08);
    }
    #global-search-results .list-group-item{ border:none; }

    /* Item detail card */
    #card-item-detail{ position:sticky; bottom:0; }

    /* FAB Quick IO */
    #fab-quick-io{
      position:fixed; right:16px; bottom:16px; z-index:1050;
      width:56px; height:56px; border-radius:50%; box-shadow:0 10px 30px rgba(2,6,23,.18);
    }
    @media (min-width: 993px){ #fab-quick-io{ right:24px; bottom:24px; } }

    /* Scan areas */
    #io-scan-area, #scan-area, #qio-scan-area, #cy-scan-area{
      background:#0f172a08; border:1px dashed #cbd5e1; border-radius:.5rem;
      display:flex; align-items:center; justify-content:center; min-height:220px;
    }

    /* Table scroll */
    .table-wrap{ overflow:auto; }

    /* Global loading */
    #global-loading{ position:fixed; inset:0; background:rgba(255,255,255,.6); backdrop-filter:saturate(140%) blur(2px);
      z-index:2000; display:flex; align-items:center; justify-content:center; }

    /* -------- Metric Cards (ikon + warna) -------- */
    .metric-card{
      display:flex; gap:14px; align-items:center;
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      padding:16px 18px; box-shadow:0 8px 26px rgba(15,23,42,.06);
    }
    .metric-card .mc-icon{
      width:52px; height:52px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-size:24px;
    }
    .metric-card .mc-meta{ line-height:1.1 }
    .metric-card .mc-label{ font-size:12px; color:#6b7280; letter-spacing:.02em }
    .metric-card .mc-value{ font-size:28px; font-weight:800; margin-top:4px }

    .mc-items .mc-icon{ background:linear-gradient(135deg,#dbeafe,#bfdbfe); color:#1d4ed8 }
    .mc-low   .mc-icon{ background:linear-gradient(135deg,#fee2e2,#fecaca); color:#b91c1c }
    .mc-users .mc-icon{ background:linear-gradient(135deg,#e9d5ff,#ddd6fe); color:#6d28d9 }

    /* Charts fixed heights (kolom kanan tidak kosong) */
    .chart-box{ position:relative; width:100% }
    .chart-lg{ height:380px }
    .chart-sm{ height:260px }
    .chart-box canvas{ width:100% !important; height:100% !important; }
  </style>
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button id="btn-menu" class="btn btn-outline-secondary btn-sm d-lg-none"><i class="bi bi-list"></i></button>
    <div class="brand">
      <img id="brand-logo" src="logo.png" alt="logo"/>
      <div class="ttl">在庫管理</div>
    </div>

    <!-- Global Search -->
    <div id="global-search-wrap" class="d-none d-md-block">
      <input id="global-search" class="form-control form-control-sm" type="search" placeholder="検索（コード／品名／置場）"/>
      <div id="global-search-results" class="list-group small"></div>
    </div>

    <div class="appbar-actions">
      <span id="who" class="text-muted small"></span>
      <button id="btn-logout" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>
  </header>

  <!-- Layout -->
  <div class="app-layout">
    <!-- Sidebar -->
    <aside>
      <div class="menu">
        <nav class="d-grid gap-1">
          <a href="#" class="active" data-view="view-dashboard"><i class="bi bi-speedometer2"></i><span>ダッシュボード</span></a>
          <a href="#" data-view="view-items"><i class="bi bi-box-seam"></i><span>商品一覧</span></a>
          <a href="#" data-view="view-io"><i class="bi bi-arrow-left-right"></i><span>入出庫</span></a>
          <a href="#" data-view="view-shelf"><i class="bi bi-upc-scan"></i><span>棚卸（簡易）</span></a>
          <a href="#" data-view="view-cycle"><i class="bi bi-clipboard-check"></i><span>棚卸セッション</span></a>
          <a href="#" data-view="view-shelf-list"><i class="bi bi-table"></i><span>棚卸一覧</span></a>
          <a href="#" data-view="view-history"><i class="bi bi-clock-history"></i><span>履歴</span></a>
          <a href="#" data-view="view-users"><i class="bi bi-people"></i><span>ユーザー</span></a>
        </nav>
      </div>
    </aside>
    <div id="sb-backdrop"></div>

    <!-- Main -->
    <main>
      <!-- Dashboard -->
      <section id="view-dashboard" class="active">
        <h5 id="page-title" class="mb-3">ダッシュボード</h5>

        <!-- Metric cards -->
        <div class="row g-3 align-items-stretch">
          <div class="col-12 col-md-4">
            <div class="metric-card mc-items h-100">
              <div class="mc-icon"><i class="bi bi-box-seam"></i></div>
              <div class="mc-meta">
                <div class="mc-label">商品数</div>
                <div class="mc-value" id="metric-total-items">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="metric-card mc-low h-100">
              <div class="mc-icon"><i class="bi bi-exclamation-triangle"></i></div>
              <div class="mc-meta">
                <div class="mc-label">在庫不足</div>
                <div class="mc-value" id="metric-low-stock">0</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="metric-card mc-users h-100">
              <div class="mc-icon"><i class="bi bi-people"></i></div>
              <div class="mc-meta">
                <div class="mc-label">ユーザー</div>
                <div class="mc-value" id="metric-users">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action bar -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div></div>
          <div class="d-flex gap-2">
            <button id="btn-export-mov" class="btn btn-outline-primary">
              <i class="bi bi-download me-1"></i> 月次IN/OUT CSV
            </button>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mt-2">
          <div class="col-12 col-lg-8">
            <div class="card">
              <div class="card-body">
                <div class="fw-semibold mb-2">月次推移</div>
                <div class="chart-box chart-lg"><canvas id="chart-monthly"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card">
              <div class="card-body">
                <div class="fw-semibold mb-2">直近 IN/OUT</div>
                <div class="chart-box chart-sm"><canvas id="chart-pie"></canvas></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Item Detail sticky -->
        <div id="card-item-detail" class="card d-none mt-3">
          <div class="card-body" id="item-detail-body"></div>
          <div class="card-footer text-end">
            <button id="btn-close-detail" class="btn btn-outline-secondary btn-sm">閉じる</button>
          </div>
        </div>

        <!-- Floating Quick IO (mobile) -->
        <button id="fab-quick-io" class="btn btn-primary d-lg-none"><i class="bi bi-plus-lg"></i></button>
      </section>

      <!-- Items -->
      <section id="view-items" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">商品一覧</h5>
          <div class="d-flex gap-2">
            <input id="items-search" class="form-control form-control-sm" placeholder="フィルタ…"/>
            <button id="btn-items-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> CSV</button>
            <button id="btn-items-xlsx" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-spreadsheet"></i> XLSX</button>
            <button id="btn-items-import" class="btn btn-outline-secondary btn-sm"><i class="bi bi-upload"></i> インポート</button>
            <input id="input-items-import" type="file" accept=".csv" class="d-none"/>
            <button id="btn-open-new-item" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> 新規商品</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>QR</th><th>コード</th><th>商品名</th><th>画像</th>
                <th class="text-end">価格</th><th class="text-end">在庫</th><th class="text-end">最小</th>
                <th>部門</th><th>置場</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="tbl-items"></tbody>
          </table>
        </div>
      </section>

      <!-- IO (入出庫) -->
      <section id="view-io" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">入出庫</h5>
          <div class="d-flex gap-2">
            <button id="btn-io-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> 最近200 CSV</button>
            <button id="btn-io-import" class="btn btn-outline-secondary btn-sm"><i class="bi bi-upload"></i> インポート</button>
            <input id="input-io-import" type="file" accept=".csv" class="d-none"/>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <form id="form-io" class="row g-3">
                <div class="col-12">
                  <label class="form-label">コード</label>
                  <div class="input-group">
                    <input id="io-code" class="form-control" placeholder="ITEM|XXX または コード"/>
                    <button id="btn-io-lookup" class="btn btn-outline-secondary">検索</button>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label">数量</label>
                  <input id="io-qty" type="number" class="form-control" value="1"/>
                </div>
                <div class="col-6">
                  <label class="form-label">単位</label>
                  <input id="io-unit" class="form-control" value="pcs"/>
                </div>
                <div class="col-12">
                  <label class="form-label">種別</label>
                  <select id="io-type" class="form-select">
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                    <option value="ADJUST">ADJUST</option>
                  </select>
                </div>

                <div class="col-12">
                  <div class="row g-2">
                    <div class="col">
                      <label class="form-label">名称</label>
                      <input id="io-name" class="form-control" readonly/>
                    </div>
                    <div class="col">
                      <label class="form-label">価格</label>
                      <input id="io-price" class="form-control" readonly/>
                    </div>
                    <div class="col">
                      <label class="form-label">在庫</label>
                      <input id="io-stock" class="form-control" readonly/>
                    </div>
                  </div>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button class="btn btn-primary"><i class="bi bi-check2-circle"></i> 登録</button>
                  <button id="btn-io-scan" type="button" class="btn btn-outline-primary"><i class="bi bi-upc-scan"></i> スキャン</button>
                  <button id="btn-io-stop" type="button" class="btn btn-outline-secondary">停止</button>
                </div>
              </form>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <div class="fw-semibold mb-2">カメラ</div>
              <div id="io-scan-area">カメラ待機中…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Stocktake (簡易 棚卸) -->
      <section id="view-shelf" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">棚卸（簡易）</h5>
          <div class="d-flex gap-2">
            <input id="st-filter" class="form-control form-control-sm" placeholder="フィルタ…"/>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <div class="row g-2">
                <div class="col-8 col-md-6">
                  <input id="st-code" class="form-control" placeholder="コード"/>
                </div>
                <div class="col-4 col-md-3">
                  <input id="st-qty" type="number" class="form-control" placeholder="数量"/>
                </div>
                <div class="col-12 col-md-3 d-grid">
                  <button id="st-add" class="btn btn-primary">追加</button>
                </div>
              </div>
              <div class="mt-3">
                <div class="fw-semibold small text-muted" id="st-summary">件数: 0</div>
              </div>
              <div class="table-wrap mt-2">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>コード</th><th>品名</th><th>部門</th>
                      <th class="text-end">帳簿</th><th class="text-end">実棚</th><th class="text-end">差異</th><th class="text-end">操作</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-stocktake"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">スキャン</div>
                <div class="d-flex gap-2">
                  <button id="btn-start-scan" class="btn btn-outline-primary btn-sm"><i class="bi bi-upc-scan"></i> 開始</button>
                  <button id="btn-stop-scan" class="btn btn-outline-secondary btn-sm">停止</button>
                </div>
              </div>
              <div class="mt-2" id="scan-area">カメラ待機中…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Cycle Count Session -->
      <section id="view-cycle" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">棚卸セッション（サイクルカウント）</h5>
          <div class="d-flex gap-2">
            <input id="cy-zone" class="form-control form-control-sm text-uppercase" placeholder="ゾーン（例：A- または *）"/>
            <button id="cy-exp" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> CSV</button>
            <button id="cy-clear" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i> クリア</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-5">
            <div class="card p-3 h-100">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">スキャン</div>
                <div class="d-flex gap-2">
                  <button id="cy-start" class="btn btn-outline-primary btn-sm"><i class="bi bi-upc-scan"></i> 開始</button>
                  <button id="cy-stop" class="btn btn-outline-secondary btn-sm">停止</button>
                </div>
              </div>
              <div id="cy-scan-area" class="mt-2">カメラ待機中…</div>
            </div>
          </div>
          <div class="col-12 col-lg-7">
            <div class="card p-3 h-100">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">結果</div>
                <div id="cy-info" class="small text-muted">件数：0</div>
              </div>
              <div class="table-wrap mt-2">
                <table id="cy-table" class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr><th>コード</th><th>品名</th><th class="text-end">数量</th><th>置場</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tana List -->
      <section id="view-shelf-list" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">棚卸一覧</h5>
          <div class="d-flex gap-2">
            <button id="tana-recap-export-monthly" class="btn btn-outline-primary btn-sm">月次CSV</button>
            <button id="tana-recap-export-yearly" class="btn btn-outline-primary btn-sm">年次CSV</button>
            <button id="tana-matome-exp" class="btn btn-outline-primary btn-sm">まとめCSV</button>
            <button id="tana-exp" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> エクスポート</button>
            <label class="btn btn-outline-secondary btn-sm mb-0">
              <i class="bi bi-upload"></i> インポート
              <input id="input-tana-imp" type="file" accept=".csv,.xlsx" class="d-none"/>
            </label>
          </div>
        </div>
        <div class="card p-3">
          <div class="table-wrap">
            <table id="tbl-tana" class="table table-sm align-middle"></table>
          </div>
        </div>
      </section>

      <!-- History -->
      <section id="view-history" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">履歴</h5>
          <button id="btn-history-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> CSV</button>
        </div>
        <div class="card p-3">
          <div class="table-wrap">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>日時</th><th>ユーザーID</th><th>ユーザー名</th><th>コード</th><th>品名</th>
                  <th class="text-end">数量</th><th>単位</th><th>種別</th><th>備考</th><th></th>
                </tr>
              </thead>
              <tbody id="tbl-history"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Users -->
      <section id="view-users" class="d-none">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">ユーザー</h5>
          <div class="d-flex gap-2">
            <button id="btn-users-export" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> CSV</button>
            <button id="btn-users-import" class="btn btn-outline-secondary btn-sm"><i class="bi bi-upload"></i> インポート</button>
            <input id="input-users-import" type="file" accept=".csv" class="d-none"/>
            <button id="btn-print-qr-users" class="btn btn-outline-secondary btn-sm"><i class="bi bi-printer"></i> 印刷</button>
            <button id="btn-open-new-user" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> 新規ユーザー</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <div class="card p-3">
              <div class="table-wrap">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr><th>QR</th><th>ID</th><th>氏名</th><th>権限</th><th class="text-end">操作</th></tr>
                  </thead>
                  <tbody id="tbl-userqr"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-5">
            <div id="print-qr-users-grid" class="card p-3 h-100">
              <div class="text-muted small">印刷するユーザーQRを左の表から選択してダウンロードしてください。</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Quick IN/OUT Modal -->
  <div class="modal fade" id="modal-quick-io" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick IN/OUT</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="form-quick-io" class="row g-3">
            <div class="col-12 col-lg-7">
              <label class="form-label">コード</label>
              <div class="input-group">
                <input id="qio-code" class="form-control" placeholder="スキャンまたは入力"/>
                <button id="qio-scan" type="button" class="btn btn-outline-primary"><i class="bi bi-upc-scan"></i> スキャン</button>
              </div>
              <div class="small text-muted mt-1" id="qio-preview"></div>
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label">数量</label>
              <input id="qio-qty" type="number" class="form-control" value="1"/>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">単位</label>
              <input id="qio-unit" class="form-control" value="pcs"/>
            </div>
            <div class="col-12">
              <label class="form-label me-2">種別</label>
              <div class="d-flex gap-3">
                <label class="form-check-label"><input type="radio" name="qio-type" id="qio-in" value="IN" class="form-check-input me-1" checked> IN</label>
                <label class="form-check-label"><input type="radio" name="qio-type" value="OUT" class="form-check-input me-1"> OUT</label>
                <label class="form-check-label"><input type="radio" name="qio-type" value="ADJUST" class="form-check-input me-1"> ADJUST</label>
              </div>
            </div>
            <div class="col-12">
              <div id="qio-scan-area" class="mt-2">カメラ待機中…</div>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary"><i class="bi bi-check2-circle"></i> 登録</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Loading -->
  <div id="global-loading" class="d-none">
    <div class="card p-3">
      <div class="d-flex align-items-center gap-3">
        <div class="spinner-border text-primary" role="status" style="width:2rem;height:2rem"></div>
        <div id="loading-text">読み込み中…</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          onerror="this.onerror=null;this.src='vendor/bootstrap.bundle.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Config then App -->
  <script src="config.js?v=20251107"></script>
  <script src="app.js?v=20251107"></script>
</body>
</html>
