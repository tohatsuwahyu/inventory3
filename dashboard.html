<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>在庫管理 - ダッシュボード</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap.min.css'"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='vendor/bootstrap-icons.css'"/>

  <link href="styles.css?v=20251105" rel="stylesheet"/>
  <link href="print.css?v=20251030" rel="stylesheet"/>

  <style>
    header.appbar{position:sticky;top:0;z-index:1020;background:#fff;border-bottom:1px solid #e5e7eb}
    .app-view{min-height:60vh}
    .items-toolbar .left .search{max-width:280px}
    .app-nav .nav-link.active{font-weight:600}
  </style>
</head>
<body>
<header class="appbar py-2">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <img id="brand-logo" src="" alt="" style="height:28px"/>
      <strong>在庫管理</strong>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span id="user-name"></span><span class="badge bg-secondary" id="user-role"></span>
      <button id="btn-logout" class="btn btn-sm btn-outline-secondary">ログアウト</button>
    </div>
  </div>
</header>

<main class="container my-3">
  <ul class="nav nav-tabs app-nav mb-3">
    <li class="nav-item"><a class="nav-link active" href="#view-home">ホーム</a></li>
    <li class="nav-item"><a class="nav-link" href="#view-io">入出庫</a></li>
    <li class="nav-item"><a class="nav-link" href="#view-shelf">棚卸</a></li>
    <li class="nav-item"><a class="nav-link" href="#view-report">レポート</a></li>
  </ul>

  <!-- ========= Home ========= -->
  <section id="view-home" class="app-view">
    <div class="card p-3">
      <h5 class="mb-3">ダッシュボード</h5>
      <div id="home-content">ようこそ</div>
      <div>
        <button id="btn-open-new-item" class="btn btn-sm btn-outline-primary admin-only d-none">
          <i class="bi bi-plus-lg me-1"></i> 新規アイテム
        </button>
      </div>
    </div>
  </section>

  <!-- ========= 入出庫 ========= -->
  <section id="view-io" class="app-view d-none">
    <div class="card p-3 mb-3">
      <div class="items-toolbar d-flex justify-content-between align-items-center">
        <div class="left fw-semibold">スキャン</div>
        <div class="right">
          <button id="btn-io-scan" class="btn btn-sm btn-primary"><i class="bi bi-camera-video me-1"></i> 開始</button>
          <button id="btn-io-stop" class="btn btn-sm btn-outline-secondary">停止</button>
        </div>
      </div>
      <div id="io-scan-area" class="border rounded p-3 text-center text-muted">カメラ待機中…</div>
    </div>

    <div class="card p-3">
      <form id="form-io" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">コード</label>
          <div class="input-group">
            <input id="io-code" class="form-control"/>
            <button type="button" id="btn-io-lookup" class="btn btn-outline-secondary">検索</button>
          </div>
        </div>
        <div class="col-md-4"><label class="form-label">名称</label><input id="io-name" class="form-control" readonly></div>
        <div class="col-md-2"><label class="form-label">数量</label><input id="io-qty" type="number" class="form-control" value="1" min="1"></div>
        <div class="col-md-2">
          <label class="form-label">モード</label>
          <select id="io-mode" class="form-select">
            <option value="in">入庫</option>
            <option value="out">出庫</option>
          </select>
        </div>
        <div class="col-12"><button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> 登録</button></div>
      </form>
    </div>
  </section>

  <!-- ========= 棚卸 ========= -->
  <section id="view-shelf" class="app-view d-none">
    <div class="card p-3 mb-3">
      <div class="items-toolbar d-flex justify-content-between align-items-center">
        <div class="left fw-semibold">スキャン</div>
        <div class="right">
          <button id="btn-start-scan" class="btn btn-sm btn-primary"><i class="bi bi-camera-video me-1"></i> 開始</button>
          <button id="btn-stop-scan" class="btn btn-sm btn-outline-secondary">停止</button>
        </div>
      </div>
      <div id="scan-area" class="border rounded p-3 text-center text-muted">カメラ待機中…</div>
    </div>

    <div class="card p-3">
      <div class="items-toolbar d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="left">
          <div class="fw-semibold mb-1">棚卸入力</div>
          <input id="st-filter" class="form-control search" placeholder="コード/名称で絞り込み…" style="max-width:280px"/>
        </div>
        <div class="right d-flex align-items-center gap-2 flex-wrap">
          <button id="st-export" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
          <button id="st-export2" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download me-1"></i> エクスポート</button>
          <button id="st-import" class="btn btn-sm btn-outline-primary"><i class="bi bi-upload me-1"></i> インポート</button>
          <input id="input-st-import" type="file" accept=".csv" class="d-none">
          <button id="st-save" class="btn btn-sm btn-outline-secondary"><i class="bi bi-save me-1"></i> 下書き保存</button>
          <button id="st-load" class="btn btn-sm btn-outline-secondary"><i class="bi bi-folder2-open me-1"></i> 読込</button>
          <button id="st-clear" class="btn btn-sm btn-outline-secondary"><i class="bi bi-eraser me-1"></i> クリア</button>
          <label class="ms-2 small d-inline-flex align-items-center">
            <input id="st-only-diff" type="checkbox" class="form-check-input me-1"/> 差異のみ
          </label>
          <!-- Tombol baru: generator QR LOT -->
          <button id="st-open-lotgen" class="btn btn-sm btn-outline-secondary"><i class="bi bi-qr-code me-1"></i> 箱バーコード作成</button>
          <button id="st-finalize" class="btn btn-sm btn-danger"><i class="bi bi-check2-circle me-1"></i> 確定(在庫更新)</button>
        </div>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-md-4"><label class="form-label">コード</label><input id="st-code" class="form-control"/></div>
        <div class="col-md-3"><label class="form-label">実在</label><input id="st-qty" type="number" class="form-control"/></div>
        <div class="col-md-2 d-flex align-items-end"><button id="st-add" class="btn btn-primary w-100">追加</button></div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>コード</th>
              <th>名称</th>
              <th>部門</th>
              <th class="text-end">帳簿</th>
              <th class="text-end">実在</th>
              <th class="text-end">差異</th>
              <th class="text-end">操作</th>
            </tr>
          </thead>
          <tbody id="tbl-stocktake"></tbody>
        </table>
        <div id="st-summary" class="mt-2 small text-muted"></div>
      </div>
    </div>
  </section>

  <!-- ========= レポート ========= -->
  <section id="view-report" class="app-view d-none">
    <div class="card p-3">
      <h5>レポート</h5>
      <div id="report-area"></div>
    </div>
  </section>
</main>

<!-- Global Loading -->
<div id="global-loading" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background:rgba(255,255,255,.6);z-index:2000">
  <div class="d-flex h-100 align-items-center justify-content-center">
    <div class="text-center bg-white p-3 rounded shadow">
      <div class="spinner-border"></div>
      <div id="loading-text" class="mt-2 small">読み込み中…</div>
    </div>
  </div>
</div>

<!-- Modal: Lot/Box QR Generator -->
<div class="modal fade" id="lotgenModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">箱バーコード作成（LOT）</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-7">
            <label class="form-label">コード（ITEM）</label>
            <input id="lotgen-code" class="form-control" list="lotgen-codes" placeholder="SKU-001">
            <datalist id="lotgen-codes"></datalist>
          </div>
          <div class="col-md-5">
            <label class="form-label">1箱あたりの数量</label>
            <input id="lotgen-size" type="number" class="form-control" value="10" min="1">
          </div>
          <div class="col-12">
            <div class="small text-muted">
              エンコード例：<code>LOT|SKU-001|10</code>（1箱=10個）
            </div>
          </div>
        </div>
        <div class="mt-3 border rounded p-3 text-center">
          <div class="small text-muted mb-2">プレビュー</div>
          <div id="lotgen-preview"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="lotgen-dl" class="btn btn-primary">
          <i class="bi bi-download me-1"></i> ダウンロード
        </button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: 新規アイテム作成 -->
<div class="modal fade" id="newItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="newItemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新規アイテム</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">コード*</label>
            <input id="ni-code" class="form-control" required>
          </div>
          <div class="col-md-8">
            <label class="form-label">名称*</label>
            <input id="ni-name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">部門</label>
            <input id="ni-dept" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">最低在庫</label>
            <input id="ni-min" type="number" class="form-control" value="0" min="0">
          </div>
          <div class="col-md-3">
            <label class="form-label">単位</label>
            <input id="ni-unit" class="form-control" value="個">
          </div>
          <div class="col-md-4">
            <label class="form-label">単価</label>
            <input id="ni-price" type="number" class="form-control" value="0" min="0">
          </div>
        </div>
        <div class="small text-muted mt-2">* 必須項目</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> 作成</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </form>
  </div>
</div>

<script src="qrlib.js"></script>
<script src="app.js?v=20251105b"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        onerror="this.onerror=null;"></script>
</body>
</html>
