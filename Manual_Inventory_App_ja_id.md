# 取扱説明書 / User Guide — 在庫管理システム


---

## 1) 概要 / Ringkasan
- **目的**: 小物部品の在庫を、スマホ/PC から **QR スキャン** と **手入力** で管理する。  
- **主な機能**: ダッシュボード、入出庫（IN/OUT）、**棚卸（stok opname）**、商品一覧、ユーザー/QR、履歴、CSV/Excel エクスポート/インポート。  
- **権限**: *admin* と *user*。一部操作（アイテム編集・確定・インポート等）は **admin 限定**。

> ID: admin / user の違いで見えるボタンが変わります。Admin のみ: 新規ユーザー/商品、在庫の確定、削除、インポート等。

---

## 2) 事前準備 / Prasyarat
- **ブラウザ**: Chrome / Edge / Safari の最新版を推奨。スマホはカメラ権限を許可。
- **ネットワーク**: `config.js` の `BASE_URL` と `API_KEY` が **GAS デプロイ URL** に正しく設定済みであること。
- **ログイン**: ユーザーQR（`USER|<id>`）または実装されている手段でログイン。
- **カメラ**: スキャン時に「カメラを許可」する。背面カメラが優先されます。

---

## 3) 画面構成 / Struktur Layar
- 左の **サイドバー** で各ビューを切替:  
  **ダッシュボード / 入出庫 / 棚卸 / 商品一覧 / ユーザー / 履歴**  
- 右上: ログインユーザー表示、ログアウト。


---

## 4) ダッシュボード / Dashboard
- **指標**: アイテム数、最小在庫以下の件数、ユーザー数、直近30日の取引数（表示）。
- **グラフ**: 月次 IN/OUT（折れ線）、当月比率（円）。  
- **CSV**: 「CSV」ボタンで月次系列をダウンロード。

Tips: 指標はバックエンドのデータに依存します。グラフが空のときは履歴の登録状況を確認してください。

---

## 5) 入出庫（QR対応）/ In/Out
### 5.1 スキャン開始
1. サイドバーで **入出庫** を選択。  
2. **開始** ボタン → カメラ権限を許可。  
3. QR（`ITEM|<code>`）を読み取ると **コード** フィールドに自動入力。

> うまく読めない時: 明るい場所で、レンズを拭く。スマホは背面カメラに切替。

### 5.2 入出庫入力
1. **数量**、**単位（pcs/kg/m）**、**種別（IN/OUT）** を選択。  
2. 必要なら **照会** で品名/価格/在庫を再取得。  
3. **登録** を押すと履歴に記録され、ダッシュボードが更新されます。

### 5.3 エクスポート/インポート
- **エクスポート**: 直近200件の IO 履歴を CSV で出力。  
- **インポート**: CSV を選択して一括登録（admin 推奨）。

**CSV（IO）形式**  
`timestamp,userId,code,qty,unit,type,note`（エクスポート） /  
`userId,code,qty,unit,type,note`（インポート）

---

## 6) 棚卸（stok opname）
棚卸は本アプリの核となる機能です。**スキャン**と**手入力**を併用し、差異だけに集中できます。

### 6.1 スキャン/手入力で追加
- **スキャン**: 「開始」→ QR（`ITEM|<code>`）読み取り → 表に追加。  
- **手入力**: コードと実在数量を入力 → **追加**。  
- 既存行を再スキャンすると **同じコードの行が更新** されます。

### 6.2 表の操作
- **実在** 列は直接編集可能。差異は自動計算。  
- 上部検索で **コード/名称** フィルタ。  
- **差異のみ** チェックで差異≠0の行だけ表示。  
- 右端 **Adjust/Edit**（admin）  
  - *Adjust*: 在庫を **即時** 上書き（1件のみ）。  
  - *Edit*: 商品情報の編集モーダルを開く。

### 6.3 進捗サマリ
表の下に **明細件数 / 差異あり件数 / 差異合計 / 絶対差異** を表示。編集のたびに更新。

### 6.4 下書き（ドラフト）
- **下書き保存**: 現在の棚卸行をローカルに保存（メモ任意）。
- **読込**: 下書きを現在の入力に **マージ**（同一コードは上書き）。
- **クリア**: 現在の入力だけクリア（下書きは残す）。

> 端末が変わると別端末のローカル下書きは見えません。長時間の棚卸は定期的に保存してください。

### 6.5 エクスポート/インポート（棚卸）
- **CSV**: 2種類  
  - `CSV` … メタ情報付き（`#exportedAt`,`#userId`）+ `code,name,book,qty,diff,department`  
  - `エクスポート` … シンプル版 `code,name,book,qty,diff`
- **インポート**: `code,qty` 形式で一括反映。

### 6.6 確定（在庫更新・admin）
- **確定(在庫更新)** を押すと、全明細の **実在数量で在庫を上書き** し、差分を **ADJUST** として履歴記録します。  
- 前提: 内容を確認し、必要に応じて CSV を保管してから実行。  
- 完了後、表はクリアされます（下書きも削除）。

> 監査対応: 確定前に `CSV（メタ付き）` を保存しておくと、誰がいつエクスポートしたか証跡が残ります。

---

## 7) 商品一覧 / Items
- **検索**（名称）、**自動更新**（Off/30/60/120秒）、**CSV/Excel 出力**、**インポート**、**全件ラベル印刷**。  
- 行の右端から **編集/削除/ダウンロード/プレビュー**。  
- 左端には **64px QR**（`ITEM|<code>`）。  
- **新規商品**（admin）でコード/名称/価格/在庫/最小/置場/部門/画像URL を登録。

**CSV（Items）**  
`code,name,price,stock,min,location,department,img`

---

## 8) ユーザー / QR
- 一覧・QR 表示・DL、**エクスポート/インポート（admin）**、印刷、**新規ユーザー（admin）**。  
**CSV（Users）** `id,name,role`

> PIN の設定は GAS 側で管理します。

---

## 9) 履歴 / History
- 最新約 400 件を表示。  
- **エクスポート** で CSV 取得。  
**CSV（History）**  
`timestamp,userId,userName,code,itemName,qty,unit,type,note`

---

## 10) 権限 / Hak Akses
- **admin**: 新規作成、編集、削除、インポート、棚卸の確定、Adjust、ラベル一括印刷。  
- **user**: スキャン/入出庫、棚卸入力、エクスポート等（確定・編集・削除は不可）。

---

## 11) トラブルシューティング / Pemecahan Masalah
- **カメラが起動しない**: ブラウザのカメラ許可、HTTPS アクセス、別アプリでカメラ占有なしを確認。  
- **QR が遅い**: 明るさ・ピント・距離を調整。スマホは背面カメラに切替。  
- **CSV 文字化け**: UTF-8 で保存。Excel 取込時に区切り文字「,」を指定。  
- **API エラー**: `config.js` の `BASE_URL` `API_KEY` を確認。GAS デプロイは最新に更新。  
- **権限が足りない**: admin ログインかを確認。

---

## 12) ベストプラクティス / Best Practices
- 棚卸前に **最新アイテム情報をエクスポート** し、棚卸後に結果 CSV と合わせて保管。  
- 確定前に必ず **ドラフト保存** と **CSV（メタ付）出力**。  
- 入出庫はできるだけ **その場で** 登録（履歴の鮮度維持）。

---

## 13) よくある質問 / FAQ
**Q. ラベル印刷がずれる**  
A. ブラウザの印刷設定で余白「最小」、倍率 100%、ヘッダー/フッター非表示。

**Q. 在庫の単位を追加したい**  
A. `dashboard.html` の入出庫フォームの `<select id="io-unit">` に選択肢を追記。

**Q. データのバックアップ方法は？**  
A. 定期的に **Items/Users/History** の CSV をダウンロードし、社内ストレージに保管してください。

---

## 14) バージョン / Versi
- フロント: `dashboard.html v20251104a` / `app.js`（棚卸: ドラフト・確定・差異のみ・メタCSV 対応）  
- バックエンド: Google Apps Script（エンドポイント: `items`, `updateItem`, `users`, `upsertUser`, `history`, `log`, ほか）

---

### 付録 A) CSV サンプル / Contoh
**Items**  
```
code,name,price,stock,min,location,department,img
SKU-001,Baut M6x20,10,120,50,A-01-03,製造,https://...
```
**Users**  
```
id,name,role
USER001,Tanaka,admin
```
**Stocktake Import**  
```
code,qty
SKU-001,118
```
**IO Import**  
```
userId,code,qty,unit,type,note
USER001,SKU-001,10,pcs,IN,restock
```

---

お問い合わせ: システム担当（Wahyu）
